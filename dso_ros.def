Bootstrap: localimage
From: ../ros_base.sif

%files
    # fixed files
    # pangolin
    ../fixed_files/pangolin/install_prerequisites.sh /install_prerequisites.sh
    # dso
    ../fixed_files/dso/ImageRW_OpenCV.cpp /ImageRW_OpenCV.cpp

    # custom config

%post
    # update
    apt-get -y update
    apt-get -y upgrade

    # dependencies (libsuitesparse-dev and libopencv-dev already installed in ros_base.def)
    apt-get -y  install libeigen3-dev libboost-all-dev 

    # install pangolin
    cd /workspace
    # Clone Pangolin along with it's submodules
    git clone --recursive --depth 1 --branch v0.6 https://github.com/stevenlovegrove/Pangolin.git
    cd Pangolin
    # Install dependencies with pangolin provided and fixed script from newer pangolin version
    #rm ./scripts/install_prerequisites.sh
    mkdir scripts
    cp /install_prerequisites.sh ./scripts/install_prerequisites.sh
    rm /install_prerequisites.sh
    chmod +x ./scripts/install_prerequisites.sh
    ./scripts/install_prerequisites.sh -m apt all
    # Configure and build
    cmake -B build
    cmake --build build -j ${nproc}
    # GIVEME THE PYTHON STUFF!!!! (Check the output to verify selected python version)
    #cmake --build build -t pypangolin_pip_install -j16
    cd build
    make install

    # install dso
    # clone dso
    cd /workspace
    git clone https://github.com/JakobEngel/dso.git
    # fix files and build dso
    cd /workspace/dso
    rm src/IOWrapper/OpenCV/ImageRW_OpenCV.cpp
    cp /ImageRW_OpenCV.cpp src/IOWrapper/OpenCV/ImageRW_OpenCV.cpp
    rm /ImageRW_OpenCV.cpp
    mkdir build
    cd build
    cmake ..
    make -j ${nproc}

    # add ros compatibility
    mkdir /dso_ws

    # custom .bashrc
    echo "source /ptam_ws/devel/setup.bash" >> /svo_bashrc

%runscript
    bash --rcfile /svo_bashrc

%labels
    Author Bastian Zumbusch