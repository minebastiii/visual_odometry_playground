Bootstrap: localimage
From: ros_base.sif

#%environment
#    export ROS_HOSTNAME=localhost
#    export ROS_MASTER_URI=http://localhost:11311

%files
    ./homography.cpp /homography.cpp
    ./img_align.cpp /img_align.cpp
    ./pinhole_camera.cpp /pinhole_camera.cpp
    ./sparse_img_align.cpp /sparse_img_align.cpp
    ./test_feature_detection.cpp /test_feature_detection.cpp
    ./visualizer.cpp /visualizer.cpp
    ./output_helper.cpp /output_helper.cpp
    ./live.launch /live.launch
    ./rqt_svo /rqt_svo
    ./svo_widget.py /svo_widget.py
    ./camera_pinhole.yaml /camera_pinhole.yaml

%post
    # compile sopuhs
    cd /workspace/Sophus/build
    cmake ..
    make
    make install

    # compile fast
    cd /workspace/fast/build
    cmake ..
    make
    make install

    # clone vikit and svo to svo_ws
    mkdir /svo_ws && cd /svo_ws
    catkin config --init --mkdirs --extend /opt/ros/noetic --cmake-args -DCMAKE_BUILD_TYPE=Release -DEIGEN3_INCLUDE_DIR=/usr/include/eigen3
    cd src
    git clone https://github.com/uzh-rpg/rpg_vikit.git
    git clone https://github.com/uzh-rpg/rpg_svo.git
    mkdir /svo_ws/build
    mkdir /svo_ws/logs

    # fix rqt_svo
    cd /svo_ws/src/rpg_svo/rqt_svo/scripts
    rm rqt_svo
    cp /rqt_svo .
    rm /rqt_svo
    chmod +x rqt_svo
    # -
    cd /svo_ws/src/rpg_svo/rqt_svo/src/rqt_svo
    rm svo_widget.py
    cp /svo_widget.py .
    rm /svo_widget.py

    # fix rpg_svo files
    rm /svo_ws/src/rpg_svo/svo/src/sparse_img_align.cpp
    cp /sparse_img_align.cpp /svo_ws/src/rpg_svo/svo/src/sparse_img_align.cpp
    rm /sparse_img_align.cpp
    # -
    rm /svo_ws/src/rpg_svo/svo/test/test_feature_detection.cpp
    cp /test_feature_detection.cpp /svo_ws/src/rpg_svo/svo/test/test_feature_detection.cpp
    rm /test_feature_detection.cpp
    # -
    rm /svo_ws/src/rpg_svo/svo_ros/src/visualizer.cpp
    cp /visualizer.cpp /svo_ws/src/rpg_svo/svo_ros/src/visualizer.cpp
    rm /visualizer.cpp

    # fix rpg_vikit files
    rm /svo_ws/src/rpg_vikit/vikit_common/src/pinhole_camera.cpp
    cp /pinhole_camera.cpp /svo_ws/src/rpg_vikit/vikit_common/src/pinhole_camera.cpp
    rm /pinhole_camera.cpp
    # -
    rm /svo_ws/src/rpg_vikit/vikit_common/src/homography.cpp
    cp /homography.cpp /svo_ws/src/rpg_vikit/vikit_common/src/homography.cpp
    rm /homography.cpp
    # -
    rm /svo_ws/src/rpg_vikit/vikit_common/src/img_align.cpp
    cp /img_align.cpp /svo_ws/src/rpg_vikit/vikit_common/src/img_align.cpp
    rm /img_align.cpp
    # - (/world does not exists error fix)
    rm /svo_ws/src/rpg_vikit/vikit_ros/src/output_helper.cpp
    cp /output_helper.cpp /svo_ws/src/rpg_vikit/vikit_ros/src/output_helper.cpp
    rm /output_helper.cpp


    # add custom live.launch for svo_ros
    cd /svo_ws/src/rpg_svo/svo_ros/launch
    rm live.launch
    cp /live.launch .
    rm /live.launch

    # build catkin workspace
    catkin build

    # install usb_cam
    apt-get install ros-noetic-usb-cam

%runscript
    echo "source /svo_ws/devel/setup.bash" >> ~/.bashrc
    bash

%labels
    Author Bastian Zumbusch